#$(info LOCAL_MODULE=$(LOCAL_MODULE))
#$(info LOCAL_SRC_FILES=$(LOCAL_SRC_FILES))
#$(info LOCAL_C_INCLUDES=$(LOCAL_C_INCLUDES))
#$(info LOCAL_SHARED_LIBRARIES=$(LOCAL_SHARED_LIBRARIES))
#$(info LOCAL_STATIC_LIBRARIES=$(LOCAL_STATIC_LIBRARIES))

OBJS := $(patsubst %cpp,%o,$(LOCAL_SRC_FILES))
OBJS := $(patsubst $(LOCAL_PATH)/%,$(GLOBAL_OUTPUT_OBJ)/$(LOCAL_MODULE)/%,$(OBJS))
#$(info OBJS=$(OBJS))


all: $(LOCAL_MODULE)

.PHONY: $(LOCAL_MODULE)
$(LOCAL_MODULE): $(LOCAL_SHARED_LIBRARIES)
$(LOCAL_MODULE): $(LOCAL_STATIC_LIBRARIES)
$(LOCAL_MODULE): $(GLOBAL_OUTPUT_STATIC)/$(LOCAL_MODULE).a

$(GLOBAL_OUTPUT_STATIC)/$(LOCAL_MODULE).a: INNER_MODULE := $(LOCAL_MODULE)
$(GLOBAL_OUTPUT_STATIC)/$(LOCAL_MODULE).a: INNER_LDFLAGS := -L$(GLOBAL_OUTPUT_SHARED) -L$(GLOBAL_OUTPUT_STATIC) $(LOCAL_LDFLAGS)
$(GLOBAL_OUTPUT_STATIC)/$(LOCAL_MODULE).a: INNER_LDLIBS := $(patsubst lib%,-l%,$(LOCAL_SHARED_LIBRARIES)) $(patsubst lib%,-l%,$(LOCAL_STATIC_LIBRARIES)) $(LOCAL_LDLIBS)
$(GLOBAL_OUTPUT_STATIC)/$(LOCAL_MODULE).a: $(OBJS)
	@echo [$(INNER_MODULE)] INSTALL $@
	@-mkdir -p $(GLOBAL_OUTPUT_STATIC)
	$(hide)$(AR) cr $@ $^

#$(OBJS): OBJSDIR:=$(foreach objfile, $(OBJS), $(dir $(objfile)))
$(OBJS): INNER_MODULE:=$(LOCAL_MODULE)
$(OBJS): INNER_INC_FLAGS:=$(foreach incdir, $(LOCAL_C_INCLUDES), -I$(incdir))
$(OBJS): INNER_CXXFLAGS:= $(LOCAL_CXXFLAGS)
$(OBJS): $(GLOBAL_OUTPUT_OBJ)/$(LOCAL_MODULE)/%.o: $(LOCAL_PATH)/%.cpp
	@echo [$(INNER_MODULE)] CXX $@ '<=' $<
	@-mkdir -p $(dir $@)
	$(hide)$(CXX) $(INNER_CXXFLAGS) $(INNER_INC_FLAGS) -c $< -o $@
